#!/bin/bash

# log-archive - A tool to compress and archive system logs
# Usage: log-archive <log-directory>

# Color codes for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to display usage information
usage() {
    echo -e "${BLUE}Usage:${NC} $0 <log-directory>"
    echo ""
    echo "Example:"
    echo "  $0 /var/log"
    echo "  $0 /home/user/app/logs"
    echo ""
    echo "Description:"
    echo "  Compresses logs from the specified directory into a tar.gz archive"
    echo "  and stores it in ~/log-archives with a timestamp."
    exit 1
}

# Function to print colored messages
print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Check if log directory argument is provided
if [ $# -eq 0 ]; then
    print_error "Error: No log directory provided"
    echo ""
    usage
fi

LOG_DIR="$1"

# Validate that the directory exists
if [ ! -d "$LOG_DIR" ]; then
    print_error "Error: Directory '$LOG_DIR' does not exist"
    exit 1
fi

# Check if directory is readable
if [ ! -r "$LOG_DIR" ]; then
    print_error "Error: Directory '$LOG_DIR' is not readable"
    print_warning "Try running with sudo: sudo $0 $LOG_DIR"
    exit 1
fi

# Create archive directory in user's home if it doesn't exist
ARCHIVE_DIR="$HOME/log-archives"
if [ ! -d "$ARCHIVE_DIR" ]; then
    mkdir -p "$ARCHIVE_DIR"
    print_success "Created archive directory: $ARCHIVE_DIR"
fi

# Generate timestamp for archive filename
# Format: logs_archive_YYYYMMDD_HHMMSS.tar.gz
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
ARCHIVE_NAME="logs_archive_${TIMESTAMP}.tar.gz"
ARCHIVE_PATH="$ARCHIVE_DIR/$ARCHIVE_NAME"

# Log file to track all archive operations
LOG_FILE="$ARCHIVE_DIR/archive_log.txt"

# Display operation details
echo ""
print_info "Log Archive Tool"
echo "=================================="
print_info "Source Directory: $LOG_DIR"
print_info "Archive Location: $ARCHIVE_PATH"
echo ""

# Count files to be archived
FILE_COUNT=$(find "$LOG_DIR" -type f 2>/dev/null | wc -l)
print_info "Files to archive: $FILE_COUNT"
echo ""

# Create the tar.gz archive
print_info "Creating archive..."
if tar -czf "$ARCHIVE_PATH" -C "$(dirname "$LOG_DIR")" "$(basename "$LOG_DIR")" 2>/dev/null; then
    # Get archive size
    ARCHIVE_SIZE=$(du -h "$ARCHIVE_PATH" | cut -f1)
    
    print_success "Archive created successfully!"
    print_info "Archive size: $ARCHIVE_SIZE"
    print_info "Archive location: $ARCHIVE_PATH"
    
    # Log the archive operation
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Archived: $LOG_DIR -> $ARCHIVE_NAME (Size: $ARCHIVE_SIZE, Files: $FILE_COUNT)" >> "$LOG_FILE"
    
    echo ""
    print_success "Archive operation logged to: $LOG_FILE"
    
    # Display archive contents summary
    echo ""
    print_info "Archive Contents Summary:"
    echo "=================================="
    tar -tzf "$ARCHIVE_PATH" | head -n 10
    
    TOTAL_FILES=$(tar -tzf "$ARCHIVE_PATH" | wc -l)
    if [ "$TOTAL_FILES" -gt 10 ]; then
        echo "... and $((TOTAL_FILES - 10)) more files"
    fi
    
    echo ""
    print_success "Archive complete!"
    
else
    print_error "Failed to create archive"
    print_warning "You may need elevated permissions. Try: sudo $0 $LOG_DIR"
    exit 1
fi

# Optional: Display recent archive history
echo ""
print_info "Recent Archive History:"
echo "=================================="
if [ -f "$LOG_FILE" ]; then
    tail -n 5 "$LOG_FILE"
else
    echo "No previous archives found"
fi

echo ""
print_info "All archives are stored in: $ARCHIVE_DIR"
echo ""
